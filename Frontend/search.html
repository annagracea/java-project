<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Donors - MapMyDonor</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    #map {
      height: 400px;
      border-radius: 12px;
    }
    /* Blur effect when modal is open */
    .blurred {
      filter: blur(4px);
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Navbar -->
  <nav class="bg-white shadow-md p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-red-600">MapMyDonor</h1>
    <a href="homepage.html" class="text-gray-700 hover:text-red-600">Home</a>
  </nav>

  <!-- Page Container -->
  <div class="max-w-6xl mx-auto py-10 px-4 space-y-10">

    <!-- Search Filters -->
    <div class="bg-white shadow-lg rounded-xl p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Search Nearest Donor</h2>
      <button id="searchBtn" class="mt-6 w-full md:w-auto bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
        Find Nearest Donor
      </button>
    </div>

    <!-- Results + Map -->
    <div class="grid md:grid-cols-2 gap-8">
      
      <!-- Donor List -->
      <div class="bg-white shadow-lg rounded-xl p-6 overflow-y-auto max-h-[400px]">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Nearest Donor</h3>
        <ul id="donorList" class="space-y-4"></ul>
      </div>

      <!-- Map with modal -->
      <div class="relative">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Map View</h3>
        <div id="map"></div>

        <!-- Modal -->
        <div id="bloodGroupModal" class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
          <div class="bg-white p-6 rounded-xl shadow-lg w-80">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Select Blood Group</h2>
            <select id="modalBloodGroup" class="w-full border rounded-lg px-4 py-2 mb-4 focus:ring-2 focus:ring-red-500">
              <option value="">Select</option>
              <option>A+</option><option>A-</option>
              <option>B+</option><option>B-</option>
              <option>O+</option><option>O-</option>
              <option>AB+</option><option>AB-</option>
            </select>
            <button id="modalConfirmBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
   
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize Map
    var map = L.map('map').setView([10.8505, 76.2711], 7); // Kerala coordinates

    // Load OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Example donor markers (now with phone numbers)
    var donors = [
      { name: "John Doe", group: "A+", city: "Kochi", lat: 9.9312, lng: 76.2673, available: true, phone: "+91 9876543210" },
      { name: "Priya Sharma", group: "O-", city: "Trivandrum", lat: 8.5241, lng: 76.9366, available: false, phone: "+91 9123456789" },
      { name: "Rahul Menon", group: "B+", city: "Thrissur", lat: 10.5276, lng: 76.2144, available: true, phone: "+91 9988776655" }
    ];

    // Add all donors to map initially
    donors.forEach(donor => {
      L.marker([donor.lat, donor.lng]).addTo(map)
        .bindPopup(`<b>${donor.name}</b><br>Blood Group: ${donor.group}<br>City: ${donor.city}<br>üìû ${donor.phone}`);
    });

    // Haversine distance formula
    function getDistance(lat1, lon1, lat2, lon2) {
      function toRad(x) { return x * Math.PI / 180; }
      var R = 6371; // km
      var dLat = toRad(lat2 - lat1);
      var dLon = toRad(lon2 - lon1);
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Show modal on search button
    document.getElementById("searchBtn").addEventListener("click", () => {
      document.getElementById("bloodGroupModal").classList.remove("hidden");
      document.getElementById("map").classList.add("blurred");
    });

    // Confirm blood group
    document.getElementById("modalConfirmBtn").addEventListener("click", () => {
      var selectedGroup = document.getElementById("modalBloodGroup").value;
      if (!selectedGroup) {
        alert("Please select a blood group.");
        return;
      }

      document.getElementById("bloodGroupModal").classList.add("hidden");
      document.getElementById("map").classList.remove("blurred");

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          var userLat = position.coords.latitude;
          var userLng = position.coords.longitude;

          // Find nearest donor with matching blood group
          var matchingDonors = donors.filter(d => d.group === selectedGroup);
          if (matchingDonors.length === 0) {
            alert("No donors available with selected blood group.");
            return;
          }

          var nearest = matchingDonors.map(donor => {
            donor.distance = getDistance(userLat, userLng, donor.lat, donor.lng);
            return donor;
          }).sort((a, b) => a.distance - b.distance)[0];

          // Update donor list
          document.getElementById("donorList").innerHTML = `
            <li class="p-4 border rounded-lg hover:shadow-md">
              <p class="font-semibold text-gray-800">${nearest.name}</p>
              <p class="text-gray-600 text-sm">Blood Group: ${nearest.group} | City: ${nearest.city}</p>
              <p class="${nearest.available ? 'text-green-600' : 'text-red-600'} font-medium">
                ${nearest.available ? '‚úÖ Available Now' : '‚ùå Not Available'}
              </p>
              <p class="text-blue-600 text-sm">üìç Distance: ${nearest.distance.toFixed(2)} km</p>
              <p class="text-gray-800 font-medium">üìû ${nearest.phone}</p>
            </li>
          `;

          // Focus map on nearest donor
          map.setView([nearest.lat, nearest.lng], 10);
          L.marker([nearest.lat, nearest.lng]).addTo(map)
            .bindPopup(`<b>${nearest.name}</b><br>Blood Group: ${nearest.group}<br>City: ${nearest.city}<br>üìû ${nearest.phone}<br>Distance: ${nearest.distance.toFixed(2)} km`)
            .openPopup();

        }, () => {
          alert("Unable to get your location.");
        });
      } else {
        alert("Geolocation is not supported by your browser.");
      }
    });
  </script>
</body>
</html>
